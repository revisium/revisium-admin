server {
  listen   8080;
  listen   [::]:8080;

  client_max_body_size 0;

  root /usr/share/nginx/html;

  gzip on;
  gzip_vary on;
  gzip_min_length 1024;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_types text/plain text/css text/xml application/json application/javascript application/xml application/xml+rss text/javascript application/wasm;

  location ~* \.(?:js|css|woff|woff2|ttf|eot|ico|svg|png|jpg|jpeg|gif|webp|avif|wasm)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    try_files $uri =404;
  }

  location / {
    if ( $uri = '/index.html' ) {
      add_header Cache-Control no-store always;
    }
    try_files $uri /index.html;
    expires off;
  }

  location ${REACT_APP_GRAPHQL_SERVER_URL} {
      proxy_pass http://${REACT_APP_GRAPHQL_SERVER_HOST}:${REACT_APP_GRAPHQL_SERVER_PORT}${REACT_APP_GRAPHQL_SERVER_URL};
  }

  location ^~ ${REACT_APP_SWAGGER_SERVER_URL} {
      proxy_pass http://${REACT_APP_GRAPHQL_SERVER_HOST}:${REACT_APP_GRAPHQL_SERVER_PORT}${REACT_APP_SWAGGER_SERVER_URL};
  }

  location /.well-known/oauth-authorization-server {
      proxy_pass http://${REACT_APP_GRAPHQL_SERVER_HOST}:${REACT_APP_GRAPHQL_SERVER_PORT}/.well-known/oauth-authorization-server;
  }

  location /.well-known/oauth-protected-resource {
      proxy_pass http://${REACT_APP_GRAPHQL_SERVER_HOST}:${REACT_APP_GRAPHQL_SERVER_PORT}/.well-known/oauth-protected-resource;
  }

  location /oauth/ {
      proxy_pass http://${REACT_APP_GRAPHQL_SERVER_HOST}:${REACT_APP_GRAPHQL_SERVER_PORT}/oauth/;
  }

  location /mcp {
      proxy_pass http://${REACT_APP_GRAPHQL_SERVER_HOST}:${REACT_APP_GRAPHQL_SERVER_PORT}/mcp;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_buffering off;
      proxy_cache off;
  }

  location /env.js {
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
    return 200 'window.__env__ = {
        "REACT_APP_GRAPHQL_SERVER_URL": "${REACT_APP_GRAPHQL_SERVER_URL}",
        "REACT_APP_SWAGGER_SERVER_URL": "${REACT_APP_SWAGGER_SERVER_URL}",
        "REACT_APP_ENDPOINT_HOST": "${REACT_APP_ENDPOINT_HOST}",
        "REACT_APP_ENDPOINT_PORT": "${REACT_APP_ENDPOINT_PORT}"
    }';
  }
}


